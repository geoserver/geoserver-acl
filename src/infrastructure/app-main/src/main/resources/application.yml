# this is the embedded application configuration properties.
# Most common configurable properties are defined in values.yml, which is included by default (see spring.config.import below)
# Additionally, values.yml is copied to the Docker image container under /etc/geoserver/acl-service.yml and also
# imported by default as an optional property source
info:
  component: Access Control List service
  instance-id: ${spring.application.name}:${vcap.application.instance_id:${spring.application.instance_id:${spring.cloud.client.ip-address}}:${server.port}}
# acl-service main application configuration
# Do not edit this file. All configurable options are to be placed in the sibling values.yml,
# provided on a separate file and defined through spring.config.additional-location:file:<path to file>,
# or through environment variables or system properties.
server:
  port: 8080
  servlet.context-path: /acl
  # Let spring-boot's ForwardedHeaderFilter take care of reflecting the client-originated protocol and address in the HttpServletRequest  
  forward-headers-strategy: framework
  compression:
    enabled: true
    mime-types:
      - application/json
      - application/x-jackson-smile
  tomcat:
    use-relative-redirects: true
    # Maximum number of connections that the server accepts and processes at any given time.
    # Once the limit has been reached, the operating system may still accept connections based on the "acceptCount" property.
    max-connections: ${tomcat.max.connections:8192}
    # Maximum queue length for incoming connection requests when all possible request processing threads are in use.
    accept-count: ${tomcat.accept.count:100}
    accesslog.enabled: ${tomcat.accesslog.enabled:false}
    mbeanregistry.enabled: ${tomcat.mbeanregistry.enabled:false}
    threads:
      # Minimum amount of worker threads.
      min-spare: ${tomcat.threads.min.spare:10}
      # Maximum amount of worker threads.
      max: ${tomcat.threads.max:64}


spring:
  config:
    import:
      - classpath:/springdoc.yml
      - classpath:/security.yml
      - classpath:/values.yml
      - optional:file:/etc/geoserver/acl-service.yml
  main:
    banner-mode: off
    web-application-type: servlet
  application:
    name: acl-service
  flyway:
    enabled: true
    # this will create the schema if doesn't exist
    # note the same property is used by geoserver.acl.jpa.properties.hibernate.default_schema
    default-schema: ${pg.schema}
  jackson:
    default-property-inclusion: non-empty
    serialization:
      indent-output: true
  cache:
    type: caffeine
    caffeine:
      #CaffeineSpec supports parsing configuration off of a string
      #The string syntax is a series of comma-separated keys or key-value pairs, each corresponding to a Caffeine builder method.
      #
      #initialCapacity=[integer]
      #maximumSize=[long]
      #maximumWeight=[long]
      #expireAfterAccess=[duration]
      #expireAfterWrite=[duration]
      #refreshAfterWrite=[duration]
      #softValues: sets Caffeine.softValues.
      #recordStats: sets Caffeine.recordStats.
      spec: softValues,initialCapacity=10000,recordStats
  autoconfigure:
    exclude:
      - org.springframework.boot.jdbc.autoconfigure.DataSourceAutoConfiguration
      - org.springframework.boot.jdbc.autoconfigure.DataSourceTransactionManagerAutoConfiguration
      - org.springframework.boot.hibernate.autoconfigure.HibernateJpaAutoConfiguration
      - org.springframework.boot.jdbc.autoconfigure.JndiDataSourceAutoConfiguration
      - org.springframework.boot.amqp.autoconfigure.RabbitAutoConfiguration
  jpa:
    open-in-view: false
  rabbitmq:
    host: ${rabbitmq.host:rabbitmq}
    port: ${rabbitmq.port:5672}
    username: ${rabbitmq.user:guest}
    password: ${rabbitmq.password:guest}
    virtual-host: ${rabbitmq.vhost:}
  cloud:
    bus:
      enabled: ${geoserver.bus.enabled}
      id: ${info.instance-id}
      trace.enabled: false #switch on tracing of acks (default off).
    stream:
      bindings:
        # same bindings as for geoserver cloud
        springCloudBusOutput:
          destination: geoserver
        springCloudBusInput:
          destination: geoserver

management:
  server:
    port: 8081
  info:
    defaults.enabled: true
    env.enabled: true
    build.enabled: true
    git.enabled: true
    java.enabled: true
    os.enabled: true
  endpoint:
    health:
      probes:
        enabled: true
      show-components: when-authorized
      show-details: when-authorized
    caches.access: read-only
  endpoints:
    web.exposure.include: ['*']

jndi:
  datasources:
    acl:
      enabled: true
      wait-for-it: true
      wait-timeout: 15
      url: jdbc:postgresql://${pg.host}:${pg.port}/${pg.db}
      username: ${pg.username}
      password: ${pg.password}
      maximum-pool-size: ${pg.pool.max:50}
      minimum-idle: ${pg.pool.min:2}
      connection-timeout: ${pg.pool.connectionTimeout:3000}
      idle-timeout: ${pg.pool.idleTimeout:60000}

geoserver:
  bus.enabled: false
  acl:
    caching.enabled: ${acl.caching:true}
    datasource:
      jndi-name: ${acl.db.jndiName:java:comp/env/jdbc/acl}
      url: ${acl.db.url:}
      username: ${acl.db.username:}
      password: ${acl.db.password:}
      hikari:
        minimum-idle: ${acl.db.hikari.minimumIdle:1}
        maximum-pool-size: ${acl.db.hikari.maximumPoolSize:20}
    jpa:
      show-sql: false
      open-in-view: false
      generate-ddl: false
      properties:
        hibernate:
          format_sql: true
          default_schema: ${pg.schema}
          hbm2ddl.auto: ${acl.db.hbm2ddl.auto:validate}
# acl-service main application configuration
# Do not edit this file. All configurable options are to be placed in the sibling values.yml,
# provided on a separate file and defined through spring.config.additional-location:file:<path to file>,
# or through environment variables or system properties.
spring.web.error.include-binding-errors: always
# acl-service main application configuration
# Do not edit this file. All configurable options are to be placed in the sibling values.yml,
# provided on a separate file and defined through spring.config.additional-location:file:<path to file>,
# or through environment variables or system properties.
spring.web.error.include-message: always
# acl-service main application configuration
# Do not edit this file. All configurable options are to be placed in the sibling values.yml,
# provided on a separate file and defined through spring.config.additional-location:file:<path to file>,
# or through environment variables or system properties.
spring.web.error.include-stacktrace: on-param

